name: ci

on:
  push:
    branches: ["**"]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dotnet-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore ui-morn.slnx

      - name: Test
        run: dotnet test ui-morn.slnx --configuration Release --no-restore

  web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install
        run: npm ci

      - name: Install lightningcss linux binary
        if: runner.os == 'Linux'
        run: npm install --no-save --no-package-lock lightningcss-linux-x64-gnu

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  deploy-fly:
    needs: [dotnet-tests, web]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://ui-morn-web.fly.dev
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy A2A
        run: flyctl deploy -c deploy/fly/a2a.toml --remote-only

      - name: Deploy MCP
        run: flyctl deploy -c deploy/fly/mcp.toml --remote-only

      - name: Deploy Web
        run: flyctl deploy -c deploy/fly/web.toml --remote-only

      - name: Smoke checks
        run: |
          set -euo pipefail

          read_app() {
            local path="$1"
            local app
            app=$(grep -E '^app\s*=' -m1 "$path" | sed -E 's/.*"([^"]+)".*/\1/')
            if [ -z "$app" ]; then
              echo "Unable to read app name from ${path}" >&2
              exit 1
            fi
            echo "$app"
          }

          a2a_app="$(read_app deploy/fly/a2a.toml)"
          mcp_app="$(read_app deploy/fly/mcp.toml)"
          web_app="$(read_app deploy/fly/web.toml)"

          a2a_url="https://${a2a_app}.fly.dev/.well-known/agent-card.json"
          mcp_url="https://${mcp_app}.fly.dev/mcp"
          web_url="https://${web_app}.fly.dev"

          rpc='{"jsonrpc":"2.0","id":"smoke","method":"tools/list","params":{}}'

          wait_for() {
            local name="$1"
            shift
            local attempts=30
            local delay=5
            local i=1
            while true; do
              echo "Checking ${name} (attempt ${i}/${attempts})..."
              if "$@" >/dev/null; then
                echo "${name} ok"
                return 0
              fi
              if [ "${i}" -ge "${attempts}" ]; then
                echo "${name} failed after ${attempts} attempts" >&2
                return 1
              fi
              i=$((i + 1))
              sleep "${delay}"
            done
          }

          wait_for "A2A" curl -fsS --max-time 15 "${a2a_url}"
          wait_for "MCP" curl -fsS --max-time 15 -X POST -H "Content-Type: application/json" -d "${rpc}" "${mcp_url}"
          wait_for "Web" curl -fsS --max-time 15 "${web_url}"
